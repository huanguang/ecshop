var global={};global.cartType=-1;global.SECKILL_SUB_TYPE=1;global.CUSTOMWINE_SUB_TYPE=2;global.CAN_COD=3;global.sellerId=-1;global.WANGJIU_BANK=1;global.GIFT_TYPE=2;global.EXTCARD_TYPE=3;global.CLASS_TYPE=4;global.ACTIVITY_TYPE=5;global.DG_TYPE=30;global.minPrice=100;global.maxPrice=1000;var userGlobalData={userAllAddr:null,shipTimeData:null,shipMethodData:null,invoiceData:null};var isModify=1;var onlinePayData={};var supportList={isSupportShip:true,isSupportPay:true,isSupportInvoice:true,isSupportCod:true,isSupportGiftCard:true,isSupportCoupon:true,isSupportPoint:true};function setOrderTypeAdapter(){global.cartType=parseInt(Js.Tools.getParameterByName("ct")||-1);global.sellerId=parseInt(Js.Tools.getParameterByName("s"));if(Js.Tools.getParameterByName("b")&&Js.Tools.getParameterByName("b")=="0"){supportList.isSupportWJBank=false}if(global.cartType===global.CUSTOMWINE_SUB_TYPE){supportList.isSupportCod=false}else{if(global.cartType===global.SECKILL_SUB_TYPE){supportList.isSupportInvoice=false;supportList.isSupportCod=false;supportList.isSupportCoupon=false;supportList.isSupportWJBank=false;supportList.isSupportGiftCard=false}else{if(global.sellerId===global.GIFT_TYPE){supportList.isSupportShip=false;supportList.isSupportGiftCard=false;supportList.isSupportCoupon=false;supportList.isSupportCod=false}else{if(global.sellerId===global.EXTCARD_TYPE){userGlobalData.extcardShipFee=Js.Tools.getParameterByName("sf")||0;supportList.isSupportInvoice=false;if(userGlobalData.extcardShipFee==0){supportList.isSupportPay=false}else{supportList.isSupportGiftCard=false;supportList.isSupportCod=false;supportList.isSupportCoupon=false;supportList.isSupportWJBank=false}}else{if(global.sellerId===global.WANGJIU_BANK){supportList.isSupportInvoice=false;supportList.isSupportWJBank=false;supportList.isSupportCod=false;supportList.isSupportPay=false}else{if(global.sellerId===global.CLASS_TYPE){supportList.isSupportShip=false;supportList.isSupportCod=false}else{if(global.sellerId===global.ACTIVITY_TYPE){supportList.isSupportInvoice=false;supportList.isSupportCod=false;supportList.isSupportCoupon=false;supportList.isSupportWJBank=false;supportList.isSupportGiftCard=false}else{if(global.sellerId===global.DG_TYPE){supportList.isSupportCod=false;supportList.isSupportWJBank=false}else{if(global.sellerId!==0&&global.sellerId!==global.EXTCARD_TYPE){supportList.isSupportWJBank=false}}}}}}}}}if(global.cartType===global.CAN_COD){supportList.isSupportCod=false}if(global.sellerId==global.EXTCARD_TYPE){supportList.isSupportPoint=false}if(!supportList.isSupportInvoice){userGlobalData.INVOICE_TYPE_ID=1}if(!supportList.isSupportShip&&typeof userGlobalData.SHIPPING_METHOD_ID!="undefined"&&(userGlobalData.SHIPPING_METHOD_ID=="3"||userGlobalData.SHIPPING_METHOD_ID=="0")){delete userGlobalData.SHIPPING_METHOD_ID;delete userGlobalData.SHIPPING_TIME_ID}else{if(!supportList.isSupportCod&&typeof userGlobalData.PAYMENT_METHOD_ID!="undefined"&&userGlobalData.PAYMENT_METHOD_ID.indexOf("COD")!=-1){delete userGlobalData.PAYMENT_METHOD_ID}}if(!supportList.isSupportShip){$("#shipMethod").remove()}}$(document).ready(function(){initTemplateFun();Js.login.hasLogin(function(){Js.sendData(sendLink.addr+"api/web/query/userAddress.jsonp","type=0",getUserAddr)},{exitBn:0})});function getUserAddr(a){if(userGlobalData.ADDRESS_ID){emptyData()}else{userGlobalData=getDefaultAddr(a.result)||{};userGlobalData.defaultAddrId=getDefaultAddrId(a.result)}if(a.result.length>0){userGlobalData.userAllAddr=userAllAddrDataCheck(a);$("#address").html(Js.Tools.template("showAddressTemp",userGlobalData));showDelayShipping(userGlobalData.CITY_ID)}else{getInsertAddr(0);return}Js.sendData(sendLink.addr+"api/web/query/getShippingDict.jsonp","dict_key=shippingTime^invoiceCategory^invoiceType",getShippingDict)}function emptyData(){$("#shipMethod").html("");$("#cart").html("");$("#payMeshod").html("");$("#cashItem").html("");$("#leftMess").hide();$("#summary").html("").hide();$("#goodsLoading").show();delete userGlobalData.giftCash;delete userGlobalData.virtualCash;delete userGlobalData.couponCash;delete userGlobalData.pointCash}function getShippingDict(a){userGlobalData.shipTimeData=a.result[0].shippingTime;userGlobalData.invoiceData=a.result[0];Js.sendData(sendLink.addr+"api/web/query/getDestinationSM.jsonp","destination_district_id="+userGlobalData.DISTRICT_ID,getDestinationSM)}function getDestinationSM(a){userGlobalData.shipMethodData=a.result;userGlobalData.SHIPPING_TIME_ID=userGlobalData.SHIPPING_TIME_ID||1;userGlobalData.SHIPPING_METHOD_ID=userGlobalData.SHIPPING_METHOD_ID||1;if(userGlobalData.SHIPPING_TIME_ID=="0"){userGlobalData.SHIPPING_TIME_ID=1;userGlobalData.SHIPPING_TIME_NAME=getShippingTimeNameById(1)}if(userGlobalData.SHIPPING_METHOD_ID=="0"){userGlobalData.SHIPPING_METHOD_ID=1;userGlobalData.SHIPPING_METHOD_NAME=getShippingMethodNameById(1)}userGlobalData.supportList=supportList;$("#shipMethod").html(Js.Tools.template("shipMethodTemp",userGlobalData)).show();adapterProductData()}function adapterProductData(){setOrderTypeAdapter();if(global.sellerId===global.EXTCARD_TYPE){Js.sendData(sendLink.orpe+"api/list/getExtractCardForOrder.jsonp","card_id="+Js.Tools.getParameterByName("c")+"&card_pass="+Js.Tools.getParameterByName("p"),getCartItemData)}else{if(global.sellerId==global.WANGJIU_BANK||global.cartType==global.SECKILL_SUB_TYPE||global.cartType==global.CUSTOMWINE_SUB_TYPE||global.sellerId===global.ACTIVITY_TYPE){setCartIetmData()}else{Js.sendData(sendLink.cart+"api/web/query/viewCart.jsonp","sellerId="+global.sellerId+"&cartType=0",getCartItemData)}}}function getCartItemData(d){if(d.result.length===0||d.status!="1"){$("#cart").html(Js.Tools.template("cartTitleTemp",{})).show();$("#goodsLoading").html("购物车内无商品！");alert("购物车内无商品！请重新添加",function(){window.location.href="/index.html"});return}if(global.WANGJIU_BANK==global.sellerId&&d.result[0].price_tag!=-1){$("#wjBank").show()}if(global.sellerId==global.ACTIVITY_TYPE){d.result[0].showHref=false}$("#cart").html(Js.Tools.template("cartTitleTemp",{})+Js.Tools.template("cartItemTemp",d.result[0])).show();$("#cartItem").append(Js.Tools.template("productTemp",d.result[0]));for(var c=0;c<d.result[0].suite.length;c++){var g=d.result[0].suite[c],e=0,a=0,k=0,f=0;for(var b=0,h=g.productInfo.length;b<h;b++){g.productInfo[b].salePrice=parseFloat(g.productInfo[b].salePrice);g.productInfo[b].points=parseFloat(g.productInfo[b].points);g.productInfo[b].reduce=parseFloat(g.productInfo[b].reduce);e+=g.productInfo[b].salePrice;a+=g.productInfo[b].points;f+=(g.productInfo[b].salePrice-g.productInfo[b].reduce)*g.productInfo[b].groupQuantity;k+=g.productInfo[b].reduce}g.allPrice=e;g.allmask=a;g.allCount=f;g.allReduce=k}$("#cartItem").append(Js.Tools.template("suiteTemp",d.result[0]));if(d.result[0].ORDER_PROMOTION){if(!Js.Tools.isEmptyObject(d.result[0].ORDER_PROMOTION.SELECT)){$("#cartItem").append(Js.Tools.template("exchangeTemp",d.result[0].ORDER_PROMOTION.SELECT))}if(d.result[0].ORDER_PROMOTION.GIFT){$("#cartItem").append(Js.Tools.template("orderGiftTemp",d.result[0].ORDER_PROMOTION))}}calcSummary(d)}function sendPayData(){if(supportList.isSupportCod&&userGlobalData.SHIPPING_METHOD_ID){Js.sendData(sendLink.addr+"api/web/query/supportCodPos.jsonp","destination_district_id="+userGlobalData.DISTRICT_ID+"&shipping_method_id="+userGlobalData.SHIPPING_METHOD_ID,function(a){getCodPosData(a)})}else{getCodPosData({result:[]})}}function getCodPosData(a){if(a.result.length&&a.result[0].SUPPORT_COD=="1"){userGlobalData.isPos=a.result[0].SUPPORT_COD_POS;supportList.isSupportCod=true}else{userGlobalData.isPos=0;supportList.isSupportCod=false}if(typeof userGlobalData.cartAllPrice!="undefined"){Js.sendData(sendLink.paym+"api/web/query/getPayMethodGroup.jsonp","installments=1&pm_type=1&cash="+(userGlobalData.cartAllPrice)+"&pids="+userGlobalData.cartAllPid,getPayData)}else{alert("系统异常！请联系客服。")}}function calcSummary(h){var f={};f.cartAllItem=0;f.cartAllReduce=0;f.cartAllMask=0;f.cartAllPrice=0;f.cartAllId="";f.cartAllItemId="";f.goodsMess="";f.bankItem="";f.cartAllPid="";f.isOrderReduces=false;var e=null,b=null;for(var g=0;g<h.result[0].products.length;g++){e=h.result[0].products[g];f.cartAllPid+=e.productId+",";f.cartAllId+=e.productId+"_"+(e.promotionId||0)+"_"+(e.groupQuantity||1)+"_"+e.purchaseQuantity+"^";f.cartAllItemId+=(e.cartItemId||0)+",";f.goodsMess+=e.purchaseQuantity+"_"+global.sellerId+"_"+e.weight+"_"+e.isLarge+"_"+e.pLong+"_"+e.wide+"_"+e.high+"_"+e.productId+"^";f.cartAllItem+=parseInt(e.purchaseQuantity);f.cartAllReduce+=e.reduce*e.purchaseQuantity;f.cartAllMask+=e.points*e.purchaseQuantity;f.cartAllPrice=f.cartAllPrice.add((e.salePrice-e.reduce).mul(e.purchaseQuantity));f.bankItem+=e.productId+"_"+e.purchaseQuantity+"^";for(var d=0;d<e.gift.length;d++){f.cartAllId+=e.gift[d].productId+"_"+e.gift[d].promotionId+"_"+(e.gift[d].groupQuantity||1)+"_"+e.gift[d].purchaseQuantity+"^";f.goodsMess+=e.gift[d].purchaseQuantity+"_"+global.sellerId+"_"+e.gift[d].weight+"_"+e.gift[d].isLarge+"_"+e.gift[d].pLong+"_"+e.gift[d].wide+"_"+e.gift[d].high+"_"+e.gift[d].productId+"^"}}e=null;for(var g=0;g<h.result[0].suite.length;g++){for(var d=0;d<h.result[0].suite[g].productInfo.length;d++){b=h.result[0].suite[g];e=b.productInfo[d];f.cartAllItemId+=e.cartItemId+",";f.cartAllPid+=e.pid+",";f.cartAllId+=e.pid+"_"+b.promotionId+"_"+e.groupQuantity+"_"+b.purchaseQuantity+"^";f.goodsMess+=parseInt(e.groupQuantity)*parseInt(b.purchaseQuantity)+"_"+global.sellerId+"_"+e.weight+"_"+e.isLarge+"_"+e.pLong+"_"+e.wide+"_"+e.high+"_"+e.productId+"^";f.cartAllItem+=parseInt(e.groupQuantity)*parseInt(b.purchaseQuantity);f.cartAllMask+=e.points*b.purchaseQuantity}f.cartAllReduce+=parseFloat(h.result[0].suite[g].reduce)*1000*h.result[0].suite[g].purchaseQuantity/1000;f.cartAllPrice=f.cartAllPrice.add(parseFloat(h.result[0].suite[g].bindingPrice)*1000*h.result[0].suite[g].purchaseQuantity/1000)}userGlobalData.giftItem="";if(h.result[0].ORDER_PROMOTION){var l=h.result[0].ORDER_PROMOTION;var a=l?l.SELECT:{};var c=l.GIFT;if(!Js.Tools.isEmptyObject(a)){f.cartAllItem+=1;f.cartAllPrice=f.cartAllPrice.add(parseFloat(a.REPLACE_PRICE));f.cartAllPid+=a.pid+",";f.cartAllId+=a.pid+"_"+a.PROMOTION_ID+"_1_"+a.PURCHASE_QUANTITY+"^";f.cartAllItemId+=a.CART_ITEM_ID+",";f.goodsMess+=a.PURCHASE_QUANTITY+"_"+global.sellerId+"_"+a.weight+"_"+a.isLarge+"_"+a.pLong+"_"+a.wide+"_"+a.high+"_"+a.pid+"^";if(c.length==0){userGlobalData.orderPromotion_id=a.PROMOTION_ID}}for(var g=0;c&&g<c.length;g++){f.cartAllItem+=1;userGlobalData.giftItem=userGlobalData.giftItem||"";f.cartAllPid+=c[g].PRODUCT_ID+",";userGlobalData.giftItem+=c[g].PRODUCT_ID+"_"+c[g].PROMOTION_ID+"_1_"+c[g].QUANTITY_MIN+"^";f.goodsMess+=c[g].QUANTITY_MIN+"_"+global.sellerId+"_"+c[g].weight+"_"+c[g].isLarge+"_"+c[g].pLong+"_"+c[g].wide+"_"+c[g].high+"_"+c[g].pid+"^"}}if(h.result[0].order_reduces){var k=h.result[0].order_reduces[0];if(k.meet_type=="0"||k.meet_type=="1"||k.meet_type=="2"){userGlobalData.orderPromotion_id=k.promotion_id;f.cartAllPrice=f.cartAllPrice.sub(parseFloat(k.reduce));f.cartAllReduce=f.cartAllReduce.add(parseFloat(k.reduce))}}f.cartAllReduce=f.cartAllReduce.toFixed(2);userGlobalData.cartAllPrice=f.cartAllPrice;userGlobalData.cartAllId=f.cartAllId;userGlobalData.cartAllItemId=f.cartAllItemId;userGlobalData.goodsMess=f.goodsMess;userGlobalData.bankItem=f.bankItem;userGlobalData.cartAllPid=f.cartAllPid;f.supportList=supportList;$("#summary").html(Js.Tools.template("summaryTemp",f));sendPayData();setSummaryEvent()}function getPayData(f){var e={};for(var d=0;d<f.result.length;d++){if(f.result[d].PM_NAME=="ACC-GC"&&supportList.isSupportGiftCard){e.giftCardData=f.result[d]}else{if(f.result[d].PM_NAME=="ACC-VA"){e.virtualData=f.result[d]}else{if(f.result[d].PM_NAME=="ACC-COUPON"&&supportList.isSupportCoupon){e.couponData=f.result[d]}else{if(f.result[d].PM_NAME=="COD"){f.payId=f.result[d].list[0].PM_NAME}else{if(f.result[d].PM_NAME=="ONLINE"){onlinePayData=f.result[d].list;onlinePayData.tabId=1;for(var c=0;c<onlinePayData.length;c++){for(var b=0;b<onlinePayData[c].list.length;b++){for(var a=0;a<onlinePayData[c].list[b].list.length;a++){if(userGlobalData.PAYMENT_METHOD_ID&&userGlobalData.PAYMENT_METHOD_ID.indexOf(onlinePayData[c].list[b].list[a].PM_NAME)!=-1){onlinePayData.tabId=c;f.payLogo=onlinePayData[c].list[b].list[a].PM_LOGO;break}}}}}}}}}}f.showDefaultBank=false;f.showBankList=false;if(typeof userGlobalData.PAYMENT_METHOD_ID!="undefined"&&/ON|COD/.test(userGlobalData.PAYMENT_METHOD_ID)){if(userGlobalData.PAYMENT_METHOD_ID.indexOf("COD")!=-1&&supportList.isSupportCod&&codAmountLimit(userGlobalData.cartAllPrice)){f.payMainId="COD";f.payId=userGlobalData.PAYMENT_METHOD_ID}else{if(userGlobalData.PAYMENT_METHOD_ID.indexOf("ON")!=-1){f.payMainId="ONLINE";f.payId=userGlobalData.PAYMENT_METHOD_ID;if(f.payLogo){f.showDefaultBank=true}else{f.showBankList=true}}else{f.payMainId="ONLINE";f.payId=userGlobalData.defaultPayId;f.showBankList=true}}}else{if(supportList.isSupportCod&&codAmountLimit(userGlobalData.cartAllPrice)&&userGlobalData.SHIPPING_METHOD_ID!="3"){f.payMainId="COD"}else{f.payMainId="ONLINE";f.payId=userGlobalData.PAYMENT_METHOD_ID||userGlobalData.defaultPayId;f.showBankList=true}}f.isPos=userGlobalData.isPos||0;f.supportList=supportList;userGlobalData.payMainId=f.payMainId;if(supportList.isSupportPay){$("#payMeshod").html(Js.Tools.template("payMethodTemp",f)).show();setOnlineShowID(onlinePayData.tabId);setOnlinePayBankEvent()}if(!supportList.isSupportPay||global.cartType==global.SECKILL_SUB_TYPE||global.cartType==global.CUSTOMWINE_SUB_TYPE){$("#goBackToCart").remove()}getShipFee();$("#cashItem").html('<div class="tlt-02">订单结算</div>').show();setCashItem(e);if(userGlobalData.invoiceData&&supportList.isSupportInvoice){showInvoice(userGlobalData.invoiceData)}$("#leftMess").show();$("#goodsLoading").hide();$("#summary").show()}function setCashItem(a){if(a.virtualData&&a.virtualData.list.length>0){$("#cashItem").append(Js.Tools.template("virtualTemp",a));setVirtualEvent()}if(supportList.isSupportGiftCard){$("#cashItem").append(Js.Tools.template("giftCardTemp",a));setGiftCardEvent()}if(supportList.isSupportCoupon){Js.sendData(sendLink.paym+"api/web/query/getAccCouponsListByUserID.jsonp","status=1&page_num=1&show_num=5&type=0",function(b){if(b.result!=""){a.appendData=b.result[0].list}$("#cashItem").append(Js.Tools.template("couponTemp",a));setCouponEvent()})}if(supportList.isSupportPoint){Js.sendData(sendLink.ucen+"api/web/query/userInfo.jsonp","selectInfo=point&pointType=1",function(c){if(c.status=="1"){userGlobalData.sumPoint=parseInt(c.result[0].point["1_point"].POINT||0);var b=parseFloat(userGlobalData.cartAllPrice+(userGlobalData.shipFee||0));$("#cashItem").append(Js.Tools.template("pointTemp",c));pointCalculation(b);setPointEvent()}})}}function pointCalculation(b){var a=Math.floor(parseFloat(b)*0.3*100);userGlobalData.maxCanUsePoint=a<=userGlobalData.sumPoint?a:userGlobalData.sumPoint;$("#sumPoint").text(userGlobalData.sumPoint);$("#maxCanUsePoint").text(userGlobalData.maxCanUsePoint)}function setVirtualEvent(){$("#virtualId").click(function(){$("#virtualContent").slideToggle();switchClass($(this))});$("#virtualInput").keyup(function(){var b=parseFloat($(this).attr("data-info"));var a=parseFloat($(this).val());if(isNaN($(this).val())||isNaN(a)||a===0){if($(this).val().length===0||a===0){a=0;$("#virtualConfirm").trigger("click")}else{$("#virtualNumWarning").html("金额输入不正确").show()}}else{if(a<0||!/^[0-9]{1}\d*(\.\d{1,2})?$/.test(a)){$("#virtualNumWarning").html("金额输入不正确").show()}else{if(a>b){$("#virtualNumWarning").html("您本次最多可以使用余额￥"+b+"").show()}else{if(a!=0&&!checkCash({virtual:a},true)){$("#virtualNumWarning").html("已超过订单金额").show()}else{$("#virtualNumWarning").html("").hide();$("#virtualCancel,#virtual").hide();$("#virtualConfirm").show()}}}}});$("#virtualUseAllCash").click(function(){var c=$("#virtualInput").attr("data-info");var a=(parseFloat(userGlobalData.cartAllPrice)).add((userGlobalData.shipFee||0)-(userGlobalData.couponCash||0)-(userGlobalData.giftCash||0));var b=c>a?a:c;$("#virtualInput").val(parseFloat(b).toFixed(2));$("#virtualConfirm").trigger("click")});$("#virtualConfirm").click(function(){if($("#virtualNumWarning").html()!=""){return}var b=$("#virtualInput").val();if(b==""){$("#virtualNumWarning").html("请输入抵扣的金额").show();return}else{$("#virtualNumWarning").html("").hide()}if(isNaN(b)){b=0}var a=parseFloat(b);if(checkCash({virtual:a},true)){userGlobalData.virtualCash=parseFloat(a.toFixed(2));userGlobalData.virtualPayType="ACC-VA_0_0_"+a+"^"}else{alert("您选择的支付金额已经足够支付此订单！");return}$("#virtualConfirm").hide();$("#virtual, #virtualCancel, #virtualCashItem").show();$("#virtualCash, #useVirtualCash").text(parseFloat(a).toFixed(2));setPayInfo()});$("#virtualCancel").click(function(){userGlobalData.virtualCash=0;delete userGlobalData.virtualPayType;$("#virtual, #virtualCancel, #virtualCashItem").hide();$("#virtualInput").val("");$("#virtualCash,#useVirtualCash").html("0");$("#virtualConfirm").show();setPayInfo()})}function setGiftCardEvent(){$("#giftCardId").click(function(){switchClass($(this));$("#giftCardContent").slideToggle()});$("#giftCardNo").unbind("keyup").keyup(function(){if($.trim($(this).val()).length>4){$("#giftCardConfirm").attr("style","")}else{$("#giftCardConfirm").attr("style","background:#ccc; border:1px solid #ccc")}});$(".giftCardCB").die("change").live("change",function(){var e=0,c=0,b="",f=0,a=(parseFloat(userGlobalData.cartAllPrice)).add((userGlobalData.shipFee||0)-(userGlobalData.couponCash||0)-(userGlobalData.virtualCash||0));$('input[name="giftCardCB"]').each(function(){if($(this).attr("checked")=="checked"){e++;var i=$(this).val();var g=i.indexOf("_");var h=parseFloat(i.substring(g+1,i.length));f=h>a?a:h;c+=f;a-=f;if(checkCash({gift:f},true)){b+="ACC-GC_"+i.substring(0,g)+"_0_"+f+"^"}if(i.substring(0,g)==0){alert("此礼品卡无法使用，请联系客服并提供此卡的卡号");$(this).prop("checked",false)}}});var d=$(this).attr("checked")?true:false;if((!d||checkCash({gift:f},true))){userGlobalData.giftPayType=b;userGlobalData.giftCash=c.toFixed(2)==0?0:parseFloat(c.toFixed(2));$("#giftCashItem").show();$("#giftCash").text(userGlobalData.giftCash);setPayInfo()}else{alert("您选择的支付金额已经足够支付此订单");e--;$(this).prop("checked",false)}$("#giftUse").text(e);$("#giftSum").text(userGlobalData.giftCash)});$("#giftCardConfirm").click(function(){var b=$("#giftCardNo").val();var a=$("#giftCardPass").val()||-1;if(b&&a){ajaxLoad("giftCardConfirm");Js.sendData(sendLink.paym_https+"api/web/query/accBindToUser.jsonp","type=ACC-GC&get_back=true&card_no="+b+"&card_pwd="+a,function(d){removeAjaxLoad("giftCardConfirm");if(d.status!="5"){alert(d.message)}if(d.status=="1"){var c=d.result[0].list[0];$("#giftCardList").append(Js.Tools.template("appendGiftCardTemp",c));$("#giftCardDataList").show()}})}else{alert("请输入正确的卡号或密码！")}$("#giftCardNo").val("");$("#giftCardPass").val("")})}function setCouponEvent(){$("#couponId").click(function(){$("#couponContent").slideToggle();switchClass($(this))});$("#couponCardNo").unbind("keyup").keyup(function(){if($.trim($(this).val()).length>4){$("#conponCardConfirm").attr("style","")}else{$("#conponCardConfirm").attr("style","background:#ccc; border:1px solid #ccc")}});$(".couponCB").die("change").live("change",function(){if($(this).attr("checked")=="checked"){if(typeof userGlobalData.couponCash=="undefined"){var c=$(this).val().split("_");var d=parseFloat(c[2]);if(d>userGlobalData.cartAllPrice){alert("订单金额在"+d+"元以上才可使用此优惠劵！");$(this).prop("checked",false);return}var e=parseFloat(c[1]);var a=(parseFloat(userGlobalData.cartAllPrice)).add((userGlobalData.shipFee||0)-(userGlobalData.couponCash||0)-(userGlobalData.virtualCash||0)-(userGlobalData.giftCash||0));var b=e>a?a:e;if(checkCash({coupon:b},true)){userGlobalData.couponCash=parseFloat(b.toFixed(2));userGlobalData.couponNo=c[0];userGlobalData.couponPayType="ACC-COUPON_"+c[0]+"_0_"+b+"^";setPayInfo()}else{alert("您选择的支付金额已经足够支付此订单！");$(this).prop("checked",false)}}else{alert("只能使用一张优惠券！");$(this).prop("checked",false)}}else{delete userGlobalData.couponCash;delete userGlobalData.couponNo;delete userGlobalData.couponPayType;var a=userGlobalData.cartAllPrice-(userGlobalData.couponCash||0)-(userGlobalData.virtualCash||0)-(userGlobalData.giftCash||0);if(a>0){setPayInfo()}}});$("#conponCardConfirm").click(function(){var a=$("#couponCardNo").val();if(a){ajaxLoad("conponCardConfirm");Js.sendData(sendLink.paym_https+"api/web/query/accBindToUser.jsonp","type=ACC-COUPON&get_back=true&card_no="+a+"&pids="+userGlobalData.cartAllPid,function(c){removeAjaxLoad("conponCardConfirm");if(c.status!="5"){alert(c.message)}if(c.status=="1"){var b=c.result[0].list[0];$("#couponList").append(Js.Tools.template("appendCouponTemp",b));$("#couponDataList").show()}})}else{alert("请输入正确的卡号或密码！")}$("#couponCardNo").val("")})}function setPointEvent(){$("#pointId").click(function(){$("#pointContent").slideToggle();switchClass($(this))});$("#pointInput").unbind("keyup").keyup(function(){var a=parseFloat($("#maxCanUsePoint").text()||0);var b=parseFloat($(this).val());if(isNaN($(this).val())||isNaN(b)||b===0){if($(this).val().length===0||b===0){b=0;$("#pointConfirm").trigger("click")}else{$("#pointNumWarning").html("金额输入不正确")}}else{if(b<0||!/^[0-9]{1}\d*(\.\d{1,2})?$/.test(b)){$("#pointNumWarning").html("金额输入不正确")}else{if(b>a){$("#pointNumWarning").html("您本次最多可以使用"+a+"积分");$(this).focus()}else{if(b!=0&&!checkCash({point:(b/100)},true)){$("#pointNumWarning").html("已超过订单金额");$(this).focus()}else{$("#pointNumWarning").html("");$("#pointCancel,#point").hide();$("#pointConfirm").show()}}}}});$("#pointConfirm").unbind("click").bind("click",function(){if($("#pointNumWarning").html()!=""){return}var c=$("#pointInput").val();if(c==""){$("#pointNumWarning").html("请输入您要使用的积分");return}else{$("#pointNumWarning").html("")}if(isNaN(c)){c=0}var a=parseFloat(c);var b=parseFloat(newToFixed(a/100));userGlobalData.usedPoint=a;userGlobalData.pointCash=b;if(checkCash({point:b},true)){userGlobalData.pointPayType="ACC-POINT_"+a+"_0_"+b}else{userGlobalData.pointCash=0;alert("您选择的支付金额已经足够支付此订单！");return}$("#pointConfirm").hide();$("#point, #pointCancel").show();$("#usePointCash, #pointCash").text(b);setPayInfo(a)});$("#pointCancel").unbind("click").bind("click",function(){userGlobalData.usedPoint=0;delete userGlobalData.pointCash;delete userGlobalData.pointPayType;$("#point,#pointCancel").hide();$("#pointInput").val("");$("#usePointCash, #pointCash").html("0");$("#pointConfirm").show();setPayInfo(0)})}function setPayInfo(n){if(userGlobalData.usedPoint>0&&typeof n=="undefined"){$("#pointCancel").trigger("click")}var d=0,a=0,b=0,l=0;if(typeof userGlobalData.giftCash!="undefined"&&userGlobalData.giftCash!=0){d=parseFloat(userGlobalData.giftCash);$("#giftCashItem").show();$("#giftCash").show()}else{$("#giftCashItem").hide()}if(typeof userGlobalData.virtualCash!="undefined"&&userGlobalData.virtualCash!=0){a=parseFloat(userGlobalData.virtualCash);$("#virtualCashItem").show();$("#virtualCash").text(a)}else{$("#virtualCashItem").hide()}if(typeof userGlobalData.couponCash!="undefined"){b=parseFloat(userGlobalData.couponCash);$("#couponCashItem").show();$("#couponCash").text(b)}else{$("#couponCashItem").hide()}if(typeof userGlobalData.pointCash!="undefined"){l=parseFloat(userGlobalData.pointCash);$("#pointCashItem").show();$("#pointCash").text(l)}else{$("#pointCashItem").hide()}var e=parseFloat(userGlobalData.cartAllPrice)-d-a-b+(userGlobalData.shipFee||0);if(e<0){e=0}if(supportList.isSupportPoint){pointCalculation(e)}var k=parseFloat(userGlobalData.cartAllPrice)-d-a-b-l+(userGlobalData.shipFee||0);if(k<0){k=0}k=k.toFixed(2);$("#summaryPrice,#orderPrice").text(k==0?0:k);var m=[],j="";if(typeof userGlobalData.virtualCash!="undefined"&&userGlobalData.virtualCash!=0){m.push("虚拟账户");j="ACC-VA"}if(typeof userGlobalData.giftCash!="undefined"&&userGlobalData.giftCash!=0){m.push("礼品卡");j=j.length?j:"ACC-GC"}if(typeof userGlobalData.couponCash!="undefined"&&userGlobalData.couponCash!=0){m.push("优惠劵");j=j.length?j:"ACC-COUPON"}if(typeof userGlobalData.pointCash!="undefined"&&userGlobalData.pointCash!=0){m.push("积分");j=j.length?j:"ACC-POINT"}userGlobalData.payInfo="";var c,g;if(userGlobalData.payMainId=="COD"){var h=$("input[name='goalPayType']:checked").val();if(h){c=h.split("|")[0];g="货到付款-"+h.split("|")[1];m.push(g);userGlobalData.payInfo=c+"_0_0_"+e+"^"}}var f,o;if(userGlobalData.payMainId=="ONLINE"){var i=$("input[name='bankItem']:checked").val();if(i){f=i.split("|")[0];o=i.split("|")[1];m.push(o);userGlobalData.payInfo=f+"_0_0_"+e+"^"}}userGlobalData.PAYMENT_METHOD_ID=f||c||j;userGlobalData.PAYMENT_METHOD_NAME=m.join("，");if(global.sellerId==global.EXTCARD_TYPE){userGlobalData.cartAllPrice=0;userGlobalData.ecard_no=Js.Tools.getParameterByName("c");userGlobalData.ecard_pw=Js.Tools.getParameterByName("p");if(userGlobalData.shipFee>0){userGlobalData.payInfo="ACC-DC_0_0_0^"+userGlobalData.payInfo}else{userGlobalData.PAYMENT_METHOD_NAME="";userGlobalData.PAYMENT_METHOD_ID="ACC-DC";userGlobalData.payInfo="ACC-DC_0_0_0"}}if(global.sellerId!=global.EXTCARD_TYPE&&userGlobalData.cartAllPrice==0){userGlobalData.PAYMENT_METHOD_ID=userGlobalData.payInfo="ACC-VA_0_0_0^";userGlobalData.PAYMENT_METHOD_NAME="0元订单无支付方式";m.push(userGlobalData.PAYMENT_METHOD_NAME)}userGlobalData.payInfo+=userGlobalData.virtualPayType||"";userGlobalData.payInfo+=userGlobalData.giftPayType||"";userGlobalData.payInfo+=userGlobalData.couponPayType||"";userGlobalData.payInfo+=userGlobalData.pointPayType||"";$("#summaryCheck").hide();if(m.length===0){if($("#paySaveCheck").length===0){$("#payConfirm").parent().append('<div id="paySaveCheck" style="color:red;" class="alertInfo">请选择一种支付方式</div>')}}else{if(e>0&&userGlobalData.PAYMENT_METHOD_ID=="ACC-COUPON"){$("#paySaveCheck").attr("style","display:none");alert("<span id='paySaveCheck' class='alertInfo'>您选择的优惠券不足以支付订单总价，请另选一种支付方式</span>");return}}}function codAmountLimit(a){supportList.isSupportCod=false;if(global.maxPrice>a&&a>=global.minPrice){supportList.isSupportCod=true;return true}return false}function setOnlineShowID(a){$(".onlineTab").removeClass("thistab");$("#onlineTab"+a).addClass("thistab");$(".tab_conbox").hide();$("#onlineBankContent"+a).show();$("#onlineBankContent"+a).undelegate("click").delegate("div","click",function(){$(".bankRotate").removeClass("bankRotate");$("img",this).addClass("bankRotate")})}function setOnlinePayBankEvent(){$("#payConfirm").unbind("click").click(function(){var a=$("input[name='bankItem']").is(":visible")&&$("input[name='bankItem']:checked").val();if(!a){if($("#paySaveCheck").length==0){$("#payConfirm").parent().append('<div id="paySaveCheck" style="color:red;" class="alertInfo">请选择一种支付方式</div>')}return}bankId=a.split("|")[0];bankName=a.split("|")[1];bankLogo=a.split("|")[2];userGlobalData.PAYMENT_METHOD_ID=bankId;userGlobalData.PAYMENT_METHOD_NAME=bankName;$("#defaultBankImg").html('<img src="'+bankLogo+'">');$("#paySaveCheck").remove();$("#bankList").hide();$("#selectBank").show();$("#summaryCheck").hide();setPayInfo()});$("div[name='bankItemDivImg']").unbind("click").bind("click",function(){$(".pay-two").addClass("pay-one").removeClass("pay-two");$(this).addClass("pay-two");$(this).find("input").attr("checked",true)});$(".onlineTab").click(function(){var a=parseInt($(this).attr("data-info"));setOnlineShowID(a)});$("#showBankList").unbind("click").click(function(){$("#bankList").show()})}function switchClass(a){if(a.hasClass("paycashopen")){a.removeClass("paycashopen").addClass("paycashclose")}else{a.removeClass("paycashclose").addClass("paycashopen")}}function showInvoice(a){userGlobalData.invoiceData.invoiceTypeId=userGlobalData.INVOICE_TYPE_ID;userGlobalData.invoiceData.invoiceTitleId=userGlobalData.INVOICE_CATEGORY_ID;userGlobalData.invoiceData.invoiceContent=userGlobalData.INVOICE_CONTENT;userGlobalData.invoiceData.invoiceTitle=userGlobalData.invoiceData.invoiceCategory;userGlobalData.invoiceData.invoiceType=userGlobalData.invoiceData.invoiceType;if(userGlobalData.invoiceData.invoiceTypeId=="0"){userGlobalData.invoiceData.invoiceTypeId=1;userGlobalData.INVOICE_TYPE_ID=1}if(userGlobalData.invoiceData.invoiceTitleId=="0"){userGlobalData.invoiceData.invoiceTitleId=1;userGlobalData.INVOICE_CATEGORY_ID=1}if(userGlobalData.invoiceData.invoiceTypeId==1||userGlobalData.invoiceData.invoiceTypeId==3){userGlobalData.invoiceData.showInvoiceNameId=false;userGlobalData.invoiceData.showInvoiceContentId=false}else{if(userGlobalData.invoiceData.invoiceTypeId==2){userGlobalData.invoiceData.showInvoiceNameId=true;userGlobalData.invoiceData.showInvoiceContentId=true}}$("#cashItem").append(Js.Tools.template("invoiceTemp",a));setInvoiceEvent()}function setInvoiceEvent(){$("#invoiceId").click(function(){$("#invoiceContent").slideToggle();switchClass($(this))});$("#invoiceConfirm").click(function(){var a=$("#invoiceNameInput").val();if(userGlobalData.INVOICE_TYPE_ID==2){if($.trim(a)==""){alert("请输入发票抬头！");return}if(/\~|\!|\@|\#|\$|\%|\^|\&|\*/.test(a)||$.trim(a).length==0){alert("请输入正确的发票抬头！");return}userGlobalData.INVOICE_CONTENT=a}$(this).parent().append("<div id='invoiceModify' class='succ'>设置成功</div>");$(this).hide()});$("#invoiceNameInput").die("change").live("change",function(){$("#invoiceModify").remove();$("#invoiceConfirm").show()})}function switchInvoiceType(b,a){$("#zengzhi").hide();$(b).addClass("option-01-s").siblings().removeClass("option-01-s");userGlobalData.INVOICE_TYPE_ID=a;userGlobalData.INVOICE_TYPE_NAME=getInvoiceTypeNameById(a);if(a==1){$("#invoiceContentId, #invoiceNameId").hide()}else{if(a==2){$("#invoiceContentId, #invoiceNameId").show()}else{if(a==3){$("#invoiceContentId, #invoiceNameId").hide();$("#zengzhi").html("<p>友情提示: <br>"+userGlobalData.invoiceData.invoiceType[2].FRIENDLY_PROMPT+"</p>").show()}}}$("#invoiceModify").remove();$("#invoiceConfirm").show()}function getInvoiceTypeNameById(b){for(var a=0;a<userGlobalData.invoiceData.invoiceType.length;a++){if(userGlobalData.invoiceData.invoiceType[a].INVOICE_TYPE_ID==b){return userGlobalData.invoiceData.invoiceType[a].INVOICE_TYPE_NAME}}}function switchInvoiceContext(a,b){$(a).addClass("option-01-s").siblings().removeClass("option-01-s");userGlobalData.INVOICE_CATEGORY_ID=b;userGlobalData.INVOICE_CATEGORY_NAME=getInvoiceContextNameById(b);$("#invoiceModify").remove();$("#invoiceConfirm").show()}function getInvoiceContextNameById(b){for(var a=0;a<userGlobalData.invoiceData.invoiceTitle.length;a++){if(userGlobalData.invoiceData.invoiceTitle[a].INVOICE_CATEGORY_ID==b){return userGlobalData.invoiceData.invoiceTitle[a].INVOICE_CATEGORY_NAME}}}function payFocus(a){userGlobalData.payMainId=a;setPayInfo();if(a=="ONLINE"){$("#selectCod").hide();document.getElementById('iiii').value = '';if(userGlobalData.PAYMENT_METHOD_ID&&userGlobalData.PAYMENT_METHOD_ID.indexOf("ON")!=-1){$("#bankList").hide();$("#selectBank").show()}else{$("#selectBank").hide();$("#bankList").show()}}else{if(a=="COD"){$("#bankList").hide();document.getElementById('iiii').value=document.getElementById('payCOD').value;$("#selectBank").hide();$("#selectCod").show()}}}function initTemplateFun(){template.helper("decode",function(a){return a||""});template.helper("getRandom",function(a){return Math.floor(Math.random()*(a+1))})}function getInsertAddr(a){Js.sendData(sendLink.addr+"api/web/query/childArea.jsonp","isarrive=0&parent_id=0",getEmptyProvinceMess);if(a==0){pop(Js.Tools.template("inputAddrTemp",{}),"",{overflow:"hidden"});$(".pop-gift-close").hide()}else{pop(Js.Tools.template("inputAddrTemp",{}))}$("#saveAddrButton").show().unbind("click").click(function(){if(a==0){setSaveAddrEvent(0)}else{setSaveAddrEvent(1)}});setInputEvent()}function getupdateAddr(b){var a=getAddrByAddrId(userGlobalData.userAllAddr,b);Js.sendData(sendLink.addr+"api/web/query/childArea.jsonp",{extData:a,param:"isarrive=0&parent_id=0"},getProvinceMess);pop(Js.Tools.template("inputAddrTemp",a));$("#saveAddrButton").show().unbind("click").click(function(){setSaveAddrEvent(2,b)});setInputEvent()}function modifyAddrMess(){ajaxLoad("modifyAddrMess");Js.sendData(sendLink.addr+"api/web/query/userAddress.jsonp","pid=0&type=0",function(a){removeAjaxLoad("modifyAddrMess");userGlobalData.userAllAddr=userAllAddrDataCheck(a);userGlobalData.defaultAddrId=getDefaultAddrId(a.result);$("#address").html(Js.Tools.template("selectAddrTemp",userGlobalData))});return false}function setSaveAddrEvent(k,b){var a=$("#inputName").val(),j=$("#detailAddr").val(),d=$("#mobile").val(),i=$("#phone").val(),n=$("#regionId0").val(),c=$("#regionId1").val(),l=$("#regionId2").val(),e=$("#regionId0 option:selected").text(),m=$("#regionId1 option:selected").text(),h=$("#regionId2 option:selected").text(),f=$("#arriveCheck").length;if(j.length===0){$("#detailAddr").trigger("blur")}if(a.length===0){$("#inputName").trigger("blur")}if(!Js.validator.rules.telphone(i)){$("#phone").trigger("blur")}if(!Js.validator.rules.mobile(d)){$("#mobile").trigger("blur")}if((n==-22||c==-22||l==-22)&&$("#regionCheck").length===0){$("#regionId2").parent().append("<span id='regionCheck' class='alertInfo'>地区信息不完整！</span>")}if($("#popAddr .alertInfo").length===0&&f===0){ajaxLoad("saveAddrButton");var g="type=0&is_default=0&receiver="+a+"&address_detail="+j+"&mobile="+d+"&phone="+i+"&province_id="+n+"&city_id="+c+"&district_id="+l+"&province_name="+e+"&city_name="+m+"&district_name="+h+"&postcode="+userGlobalData.POSTCODE;if(k==0||k==1){Js.sendData(sendLink.addr+"api/web/query/insUserAddress.jsonp",g,function(o){removeAjaxLoad("saveAddrButton");if(o.status=="1"){userGlobalData.ADDRESS_ID=o.result[0].address_id;userGlobalData.RECEIVER=a;userGlobalData.ADDRESS_DETAIL=j;userGlobalData.MOBILE=d;userGlobalData.PHONE=i||"";userGlobalData.PROVINCE_ID=n;userGlobalData.CITY_ID=c;userGlobalData.DISTRICT_ID=l;userGlobalData.PROVINCE_NAME=e;userGlobalData.CITY_NAME=m;userGlobalData.DISTRICT_NAME=h;if(k==0){document.documentElement.style.overflow="scroll";$("#wjPop-close").trigger("click");Js.sendData(sendLink.addr+"api/web/query/userAddress.jsonp","type=0",getUserAddr)}else{addUserAddrData(userGlobalData);$("#address").html(Js.Tools.template("selectAddrTemp",userGlobalData));$("#addrItem"+userGlobalData.ADDRESS_ID).attr("checked",true);$("#wjPop-close").trigger("click");getShipFee()}}})}else{if(k==2){Js.sendData(sendLink.addr+"api/web/query/updUserAddress.jsonp","address_id="+b+"&"+g,function(o){removeAjaxLoad("saveAddrButton");if(o.status=="1"){userGlobalData.ADDRESS_ID=b;userGlobalData.RECEIVER=a;userGlobalData.ADDRESS_DETAIL=j;userGlobalData.MOBILE=d;userGlobalData.PHONE=i||"";userGlobalData.PROVINCE_ID=n;userGlobalData.CITY_ID=c;userGlobalData.DISTRICT_ID=l;userGlobalData.PROVINCE_NAME=e;userGlobalData.CITY_NAME=m;userGlobalData.DISTRICT_NAME=h;updateUserAddrData(userGlobalData.userAllAddr,b);$("#address").html(Js.Tools.template("selectAddrTemp",userGlobalData));$("#wjPop-close").trigger("click")}})}}}}function setDefaultAddr(b,a){Js.sendData(sendLink.addr+"api/web/query/updUserAddressDefault.jsonp","address_id="+a,function(c){if(c.status!="1"){alert(c.message)}else{$(".setSuccess").hide();$(".defaultAddr").hide();$(".setDefaultAddr").show();$(b).parent().find(".setDefaultAddr").hide();$(b).parent().parent().find(".defaultAddr").show();$(b).next().show()}})}function deleteAddr(a){if(confirm("确认要删除此收货地址吗？")){Js.sendData(sendLink.addr+"api/web/query/delUserAddress.jsonp","address_id="+a,function(d){if(d.status!="1"){alert(d.message)}else{for(var b=0;b<userGlobalData.userAllAddr.result.length;b++){if(userGlobalData.userAllAddr.result[b]&&userGlobalData.userAllAddr.result[b].ADDRESS_ID==a){delete userGlobalData.userAllAddr.result[b];break}}$("#addrList"+a).remove();if($("#newAddrButton").length==0&&$('input[name="addrItem"]').length<5){$("#addrManage").append('<a href="javascript:void(0);" onclick="getInsertAddr();return false;" class="link-01" id="newAddrButton">增加新地址</a>')}if($('input[name="addrItem"]').length==0){getInsertAddr(0)}else{if(userGlobalData.userAllAddr.result.length>0){var c=false;$('input[name="addrItem"]').each(function(){if($(this).is(":checked")){c=true}});if(!c){$('input[name="addrItem"]').eq(0).attr("checked",true)}}}}})}}function showDelayShipping(a){Js.sendData(sendLink.addr+"api/web/query/getDelayDeliveryAreas.jsonp","area_id="+a,function(b){if(b.status==1&&b.result[0].is_delay==1){alert(" 您选择的配送区域因天气寒冷暂时无法配送，待气温恢复后会联系您安排发货。请耐心等待。")}})}function confirmAddrs(){var a=$('input[name="addrItem"]:checked').val();if(a!=userGlobalData.ADDRESS_ID){supportList.isSupportCod=true;updateGlobalAddrData(userGlobalData.userAllAddr,a);getUserAddr(userGlobalData.userAllAddr)}else{$("#address").html(Js.Tools.template("showAddressTemp",userGlobalData));$("#summaryCheck").hide()}}function setInputEvent(){$("#inputName").die("blur").live("blur",function(){$("#nameCheck").remove();if($(this).val().length===0){$(this).parent().append("<span id='nameCheck' class='alertInfo'>收件人不能为空！</span>")}else{if(!Js.validator.rules.noSymbol($(this).val())){$(this).parent().append("<span id='nameCheck' class='alertInfo'>收件人格式不正确！</span>")}}});$("#detailAddr").die("blur").live("blur",function(){$("#addrCheck").remove();if($(this).val().length===0){$(this).parent().append("<span id='addrCheck' class='alertInfo'>收货地址不能为空！</span>")}else{if($(this).val().indexOf("%")!=-1){$(this).parent().append("<span id='addrCheck' class='alertInfo'>收货地址含有非法字符！</span>")}}});$("#phone").die("blur").live("blur",function(){$("#phoneCheck").remove();$("#phoneTip").hide();if(!Js.validator.rules.telphone($(this).val())&&$(this).val().length){$(this).parent().append("<span id='phoneCheck' class='alertInfo'>请输入正确的固定电话号码！</span>")}}).focus(function(){$("#phoneCheck").remove();$("#phoneTip").show()});$("#mobile").die("blur").live("blur",function(){$("#mobileCheck").remove();if(!Js.validator.rules.mobile($(this).val())){$(this).parent().append("<span id='mobileCheck' class='alertInfo'>请输入正确的手机号码！</span>")}})}function updateGlobalAddrData(c,a){if(c.result.length>0){for(var b=0;b<c.result.length;b++){if(c.result[b]&&c.result[b].ADDRESS_ID==a){userGlobalData.ADDRESS_ID=a;userGlobalData.RECEIVER=c.result[b].RECEIVER;userGlobalData.ADDRESS_DETAIL=c.result[b].ADDRESS_DETAIL;userGlobalData.MOBILE=c.result[b].MOBILE;userGlobalData.PHONE=c.result[b].PHONE||"";userGlobalData.PROVINCE_ID=c.result[b].PROVINCE_ID;userGlobalData.CITY_ID=c.result[b].CITY_ID;userGlobalData.DISTRICT_ID=c.result[b].DISTRICT_ID;userGlobalData.PROVINCE_NAME=c.result[b].PROVINCE_NAME;userGlobalData.CITY_NAME=c.result[b].CITY_NAME;userGlobalData.DISTRICT_NAME=c.result[b].DISTRICT_NAME;userGlobalData.POSTCODE=c.result[b].POSTCODE;userGlobalData.SHIPPING_TIME_ID=c.result[b].SHIPPING_TIME_ID;userGlobalData.SHIPPING_TIME_NAME=c.result[b].SHIPPING_TIME_NAME;userGlobalData.PAYMENT_METHOD_ID=c.result[b].PAYMENT_METHOD_ID;userGlobalData.PAYMENT_METHOD_NAME=c.result[b].PAYMENT_METHOD_NAME;userGlobalData.INVOICE_TYPE_ID=c.result[b].INVOICE_TYPE_ID;userGlobalData.INVOICE_TYPE_NAME=c.result[b].INVOICE_TYPE_NAME;userGlobalData.INVOICE_CONTENT=c.result[b].INVOICE_CONTENT;userGlobalData.INVOICE_CATEGORY_ID=c.result[b].INVOICE_CATEGORY_ID;userGlobalData.INVOICE_CATEGORY_NAME=c.result[b].INVOICE_CATEGORY_NAME;break}}}}function addUserAddrData(a){var b={};b.ADDRESS_ID=a.ADDRESS_ID;b.RECEIVER=a.RECEIVER;b.ADDRESS_DETAIL=a.ADDRESS_DETAIL;b.MOBILE=a.MOBILE;b.PHONE=a.PHONE||"";b.PROVINCE_ID=a.PROVINCE_ID;b.CITY_ID=a.CITY_ID;b.DISTRICT_ID=a.DISTRICT_ID;b.PROVINCE_NAME=a.PROVINCE_NAME;b.CITY_NAME=a.CITY_NAME;b.DISTRICT_NAME=a.DISTRICT_NAME;b.POSTCODE=a.POSTCODE;a.userAllAddr.result.push(b)}function updateUserAddrData(c,a){if(c.result.length>0){for(var b=0;b<c.result.length;b++){if(c.result[b]&&c.result[b].ADDRESS_ID==a){c.result[b].ADDRESS_ID=userGlobalData.ADDRESS_ID;c.result[b].RECEIVER=userGlobalData.RECEIVER;c.result[b].ADDRESS_DETAIL=userGlobalData.ADDRESS_DETAIL;c.result[b].MOBILE=userGlobalData.MOBILE;c.result[b].PHONE=userGlobalData.PHONE||"";c.result[b].PROVINCE_ID=userGlobalData.PROVINCE_ID;c.result[b].CITY_ID=userGlobalData.CITY_ID;c.result[b].DISTRICT_ID=userGlobalData.DISTRICT_ID;c.result[b].PROVINCE_NAME=userGlobalData.PROVINCE_NAME;c.result[b].CITY_NAME=userGlobalData.CITY_NAME;c.result[b].DISTRICT_NAME=userGlobalData.DISTRICT_NAME;c.result[b].POSTCODE=userGlobalData.POSTCODE;break}}}}function userAllAddrDataCheck(b){if(b.result.length>0){for(var a=0;a<b.result.length;a++){if(b.result[a].PAYMENT_METHOD_ID=="ACC-COUPON"){b.result[a].PAYMENT_METHOD_ID="";b.result[a].PAYMENT_METHOD_NAME=""}}}return b}function getDefaultAddr(b){for(var a=0;a<b.length;a++){if(b[a].IS_DEFAULT=="1"){return b[a]}}return b[0]}function getDefaultAddrId(b){for(var a=0;a<b.length;a++){if(b[a].IS_DEFAULT=="1"){return b[a].ADDRESS_ID}}return""}function getAddrByAddrId(c,a){for(var b=0;b<c.result.length;b++){if(c.result[b]&&c.result[b].ADDRESS_ID==a){return c.result[b]}}}function getEmptyProvinceMess(a){a.pId=-22;a.region="";a.regionId=0;$("#region").append(Js.Tools.template("addrRegionTemp",a));$("#regionId0").unbind("change").change(function(){if($(this).val()==-22){$("#province").html("")}else{$("#city,#district").html("");$("#regionId1,#regionId2").html("<option value=-22>请选择</option>");$("#province").html($(this).find("option:selected").text());Js.sendData(sendLink.addr+"api/web/query/childArea.jsonp","isarrive=0&parent_id="+$(this).val(),getCityMess);userGlobalData.CITY_ID=$(this).val()}});$("#region").append(Js.Tools.template("addrEmptyRegion",{region:"",regionId:1}));$("#region").append(Js.Tools.template("addrEmptyRegion",{region:"",regionId:2}));setInputEvent()}function getProvinceMess(b,a){b.pId=a.PROVINCE_ID;b.region="";b.regionId=0;$("#region").append(Js.Tools.template("addrRegionTemp",b));$("#province").html($("#regionId0").find("option:selected").text());$("#regionId0").unbind("change").change(function(){if($(this).val()==-22){$("#province").html("")}else{$("#city,#district").html("");$("#regionId1,#regionId2").html("<option value=-22>请选择</option>");$("#province").html($(this).find("option:selected").text());Js.sendData(sendLink.addr+"api/web/query/childArea.jsonp",{extData:a,param:"isarrive=0&parent_id="+$(this).val()},getCityMess);userGlobalData.CITY_ID=$(this).val()}});if(!$("#regionId1").is(":visible")){Js.sendData(sendLink.addr+"api/web/query/childArea.jsonp",{extData:a,param:"isarrive=0&parent_id="+a.PROVINCE_ID},getCityMess)}}function getCityMess(c,a){if(!$("#regionId1").is(":visible")){Js.sendData(sendLink.addr+"api/web/query/childArea.jsonp",{extData:a,param:"isarrive=0&parent_id="+a.CITY_ID},getDistrictMess);c.region="";c.pId=a.CITY_ID;c.regionId=1;$("#region").append(Js.Tools.template("addrRegionTemp",c))}else{$("#regionId1").empty();if(c.result.length==1){Js.sendData(sendLink.addr+"api/web/query/childArea.jsonp",{extData:a,param:"isarrive=0&parent_id="+c.result[0].AREA_ID},getDistrictMess)}else{$("#regionId1").append("<option value=-22>请选择</option>")}for(var b=0;b<c.result.length;b++){$("#regionId1").append("<option value="+c.result[b].AREA_ID+" title="+c.result[b].AREA_NAME+">"+c.result[b].AREA_NAME+"</option>")}}if($("#regionId1").val()!=-22){$("#city").html($("#regionId1").find("option:selected").text())}$("#regionId1").unbind("change").change(function(){showDelayShipping($(this).val());if($(this).val()==-22){$("#city").html("")}else{$("#city").html($(this).find("option:selected").text()).addClass("regionSpace");Js.sendData(sendLink.addr+"api/web/query/childArea.jsonp",{extData:a,param:"isarrive=0&parent_id="+$(this).val()},getDistrictMess)}})}function getDistrictMess(c,a){if(!$("#regionId2").is(":visible")){c.region="";c.regionId=2;c.pId=a.DISTRICT_ID;$("#region").append(Js.Tools.template("addrRegionTemp",c))}else{$("#regionId2").empty().append("<option value=-22>请选择</option>");for(var b=0;b<c.result.length;b++){$("#regionId2").append("<option value="+c.result[b].AREA_ID+" title="+c.result[b].AREA_NAME+">"+c.result[b].AREA_NAME+"</option>")}}if($("#regionId2").val()!=-22){$("#district").html($("#regionId2").find("option:selected").text())}$("#regionId2").unbind("change").change(function(){if($(this).val()==-22){$("#district").html("")}else{$("#district").html($(this).find("option:selected").text()).addClass("regionSpace");$("#regionCheck").remove();userGlobalData.DISTRICT_ID=$(this).find("option:selected").val();for(var d=0;d<c.result.length;d++){if(c.result[d].AREA_ID==userGlobalData.DISTRICT_ID){userGlobalData.POSTCODE=c.result[d].POSTCODE}}Js.sendData(sendLink.addr+"api/web/query/getDestinationSM.jsonp","destination_district_id="+userGlobalData.DISTRICT_ID,function(g){var f=false;for(var e=0;e<g.result.length;e++){if(g.result[e].SORT=="1"){f=true}}if(!f){if($("#arriveCheck").length===0){$("#regionId2").parent().append("<span id='arriveCheck' class='alertInfo'>此地区不可送达！</span>")}}else{$("#arriveCheck").remove()}})}})}function switchShipTime(a,b){$(a).addClass("int-time-02").siblings().removeClass("int-time-02");userGlobalData.SHIPPING_TIME_ID=b;userGlobalData.SHIPPING_TIME_NAME=getShippingTimeNameById(b)}function getShippingTimeNameById(b){for(var a=0;a<userGlobalData.shipTimeData.length;a++){if(userGlobalData.shipTimeData[a].SHIPPING_TIME_ID==b){return userGlobalData.shipTimeData[a].SHIPPING_TIME_NAME}}}function switchShipMethod(b,a){$(b).parent().attr("class","oh seld").siblings().removeClass("seld");userGlobalData.SHIPPING_METHOD_ID=a;userGlobalData.SHIPPING_METHOD_NAME=getShippingMethodNameById(a);if(a=="3"){$("#shipTime").hide();$("#payONLINE").trigger("click");$("#codItem").hide();supportList.isSupportCod=false}else{$("#shipTime").show();$("#codItem").show();supportList.isSupportCod=true}}function getShippingMethodNameById(b){for(var a=0;a<userGlobalData.shipMethodData.length;a++){if(userGlobalData.shipMethodData[a].SHIPPING_METHOD_ID==b){return userGlobalData.shipMethodData[a].SHIPPING_METHOD_NAME}}}function setCartIetmData(){var a=Js.Tools.getParameterByName("pids");var e=a.split("^");var f="",c=[];for(var d=0;d<e.length;d++){f+=e[d].split("_")[0]+",";c.push(e[d].split("_")[1])}var b="";if(global.sellerId===global.WANGJIU_BANK){f=f.substring(0,f.length-1);b=sendLink.prod+"api/web/query/getProductInfo.jsonp?pids="+f}else{if(global.cartType===global.CUSTOMWINE_SUB_TYPE){b=sendLink.prod+"api/web/query/getProductInfo.jsonp?pids="+f}else{if(global.sellerId===global.ACTIVITY_TYPE){b=sendLink.prod+"api/web/query/getProductInfo.jsonp?pids="+f}else{if(global.cartType===global.SECKILL_SUB_TYPE){f=f.substring(0,f.length-1);b=sendLink.prom+"api/web/query/getPromotionById.jsonp?PROMOTION_ID="+f}}}}Js.sendData(b,"",function(l){var h={status:"1",message:"",result:[{order:[],suite:[],products:[],ORDER_PROMOTION:{GIFT:[],ALL_SELECT:{},SELECT:{}}}]};for(var k=0;k<l.result.length;k++){if(global.sellerId==global.WANGJIU_BANK||global.cartType==global.SECKILL_SUB_TYPE){l.result[k].salePrice=0}l.result[k].gift=[];l.result[k].reduce=0;l.result[k].points=0;l.result[k].promotionId=0;var o=0;var j=f.split(",");for(var g=0;g<j.length;g++){if(j[g]==l.result[k].pid){o=g;break}}l.result[k].purchaseQuantity=c[o]||1;l.result[k].productId=l.result[k].pid;if(global.cartType==global.SECKILL_SUB_TYPE){l=setProductInfo(l)}h.result[0].products.push(l.result[k])}getCartItemData(h)})}function setProductInfo(b){for(var a=0;a<b.result.length;a++){b.result[a].productId=b.result[a].PRODUCT_ID;b.result[a].promotionId=b.result[a].PROMOTION_ID;b.result[a].eb_id=b.result[a].EB_ID;b.result[a].imageSrc=b.result[a].IMAGE_SRC;b.result[a].productName=b.result[a].PRODUCT_NAME;b.result[a].englishName=b.result[a].ENGLISH_NAME;b.result[a].pid=b.result[a].PRODUCT_ID;b.result[a].salePrice=b.result[a].FINAL_PRICE;b.result[a].points=b.result[a].POINTS;b.result[a].purchaseQuantity=1;b.result[a].reduce=0}return b}function setSummaryEvent(){$("#submit").die("click").live("click",submitClickEvent);$(".giftCB").change(function(){userGlobalData.giftItem="";$(".giftCB").each(function(){if($(this).is(":checked")){userGlobalData.giftItem+=$(this).attr("value")}})})}function submitClickEvent(){var a=this;Js.login.hasLogin(function(){sendOrderData.call(a)},{exitBn:0,level:1,showLoad:true,manualClose:true,lockUserName:true})}function sendOrderData(){if(typeof userGlobalData.RECEIVER=="undefined"||$("#showAddr").length===0){$("#summaryCheck").html("请确认地址信息");$("#summaryCheck").show();Js.closeLoadContent();setAnimate("#address");return}if(supportList.isSupportShip&&(typeof userGlobalData.SHIPPING_METHOD_ID=="undefined"||userGlobalData.SHIPPING_METHOD_ID=="0")){$("#summaryCheck").html("请确认配送方式");$("#summaryCheck").show();Js.closeLoadContent();setAnimate("#shipMethod");return}if(supportList.isSupportPay&&parseInt($("#orderPrice").text())>0&&($("#payConfirm").is(":visible")||typeof userGlobalData.PAYMENT_METHOD_ID=="undefined"||userGlobalData.PAYMENT_METHOD_ID.length==0)){$("#payCheck").html("请选择支付方式");$("#payCheck").show();$("#summaryCheck").html("请确认支付方式");$("#summaryCheck").show();Js.closeLoadContent();setAnimate("#payMeshod");return}if($("#invoiceConfirm").is(":visible")){$("#summaryCheck").html("请确认发票信息").show();Js.closeLoadContent();return}var c=$("#leftMessContent").val();if(/\~|\!|\@|\#|\$|\%|\^|\&|\*|\<|\>/.test(c)){$("#summaryCheck").html("订单备注不合法").show();Js.closeLoadContent();return}var a={};a.receiver=encodeURIComponent(userGlobalData.RECEIVER);a.province_id=userGlobalData.PROVINCE_ID;a.city_id=userGlobalData.CITY_ID;a.district_id=userGlobalData.DISTRICT_ID;a.phone=userGlobalData.PHONE||"";a.mobile=userGlobalData.MOBILE||"";a.zip_code=userGlobalData.POSTCODE||"";a.postcode=userGlobalData.POSTCODE||"";a.address=encodeURIComponent(userGlobalData.ADDRESS_DETAIL);a.address_detail=encodeURIComponent(userGlobalData.ADDRESS_DETAIL);a.address_id=userGlobalData.ADDRESS_ID;a.payment_method_id=userGlobalData.PAYMENT_METHOD_ID||userGlobalData.defaultPayId;a.shipping_fee=userGlobalData.shipFee||0;a.shipping_method_id=supportList.isSupportShip?(userGlobalData.SHIPPING_METHOD_ID||0):1;a.shipping_option=a.shipping_method_id==3?0:userGlobalData.SHIPPING_TIME_ID||1;a.shipping_time_id=a.shipping_method_id==3?0:userGlobalData.SHIPPING_TIME_ID||1;a.shipping_phone_confirm=0;a.cod_method=0;a.invoice_title=encodeURIComponent(userGlobalData.INVOICE_CONTENT||"");a.invoice_content=encodeURIComponent(userGlobalData.INVOICE_CONTENT||"");a.invoice_type_id=userGlobalData.INVOICE_TYPE_ID||1;a.invoice_type=userGlobalData.INVOICE_TYPE_ID||1;a.invoice_cotent=userGlobalData.INVOICE_CATEGORY_ID||0;a.invoice_category_id=userGlobalData.INVOICE_CATEGORY_ID||0;a.default_config=userGlobalData.IS_DEFAULT||0;a.is_default=userGlobalData.IS_DEFAULT||0;a.inviter_info=0;a.order_way=0;a.promotion_id=userGlobalData.orderPromotion_id||0;a.promotion_free_shipping=0;a.split_package=0;a.order_desc=$("#leftMessContent").val();a.paymentmethodid_paymentno_paymentpw_paymentamount=userGlobalData.payInfo;a.productid_promotionid_quantityingroup_quantity=userGlobalData.cartAllId+(userGlobalData.giftItem||"");a.cartItemIds=userGlobalData.cartAllItemId;a.seller_id=global.sellerId;a.needCartDetail=true;a.ecard_no=userGlobalData.ecard_no||0;a.ecard_pw=userGlobalData.ecard_pw||0;a.type=0;a.cartType=0;a.TO_PAY=0;a.is_shfee=1;if(global.sellerId==global.WANGJIU_BANK){a.productid_quantity=userGlobalData.bankItem;a.storage_id=1}if(global.cartType==global.CUSTOMWINE_SUB_TYPE){a.wineicopath=Js.Tools.getParameterByName("wineicopath")||"";a.is_show_wineico=0}$(this).attr({"class":"settle-button-01",id:"hasSubmit"}).html("正在生成订单，请稍等...<br>").die("click");var b=Js.Tools.jsonToString(a);if(isModify){Js.sendData("https://portal.wangjiu.com/web/ms/callJsonp.action",{showLoad:true,manualClose:true,notTimeout:true,param:"index=xd_Update&"+b},getOrderData)}else{Js.sendData("https://portal.wangjiu.com/web/ms/callJsonp.action",{showLoad:true,manualClose:true,notTimeout:true,param:"index=xd&"+b},getOrderData)}}function getOrderData(f){Js.closeLoadContent();if(f.status=="1"){try{for(var b=0;b<f.result.length;b++){if(f.result[b].result[0]&&f.result[b].result[0].itemCount){var a=0;for(var c=0;c<f.result[b].result.length;c++){a+=parseInt(f.result[b].result[c].itemCount)}addCartNumCookie(a);break}}}catch(d){}window.location.href="http://www.wangjiu.com/cart/orderSucc.html?e=0&m="+$("#orderPrice").text()+"&p="+(encodeURIComponent(userGlobalData.PAYMENT_METHOD_NAME))+"&pId="+userGlobalData.PAYMENT_METHOD_ID+"&oId="+f.result[0].result[0].order_id+"&pInfo="+userGlobalData.payInfo+"&a="+$("#orderPrice").text()}else{if(f.status=="5"){Js.closeLoadContent();$("#hasSubmit").empty();$("#hasSubmit").attr("id","submit").removeClass("settle-button-01").addClass("settle-button").html("提交订单");$("#submit").die("click").live("click",submitClickEvent);if(global.cartType==global.SECKILL_SUB_TYPE){window.location.href=_basePath+"product/flashPromotion.html"}}else{window.location.href=_basePath+"cart/orderSucc.html?e=1&m="+f.message}}}function getShipFee(){if(global.sellerId==global.EXTCARD_TYPE){getShipAmount({result:[{AMOUNT:userGlobalData.extcardShipFee,DISCOUNT:0}]});return}if(userGlobalData.DISTRICT_ID){if(global.sellerId==global.WANGJIU_BANK){getShipAmount({result:[{AMOUNT:0,DISCOUNT:0}]});return}if(userGlobalData.SHIPPING_METHOD_ID!="0"&&supportList.isSupportShip){userGlobalData.SHIPPING_METHOD_ID=userGlobalData.SHIPPING_METHOD_ID||"1";var a="eb_id="+global.sellerId+"&destination_district_id="+userGlobalData.DISTRICT_ID+"&shipping_method_id="+userGlobalData.SHIPPING_METHOD_ID+"&product_info_list="+userGlobalData.goodsMess+"&order_amount="+userGlobalData.cartAllPrice;Js.sendData(sendLink.addr+"api/web/query/shippingAmount.jsonp",a,getShipAmount)}else{getShipAmount({result:[{AMOUNT:0,DISCOUNT:0}]})}}else{setPayInfo()}}function getShipAmount(a){if(a.result.length){userGlobalData.shipFee=parseFloat(a.result[0].AMOUNT||0)-parseFloat(a.result[0].DISCOUNT||0)}else{userGlobalData.shipFee=0}if(userGlobalData.shipFee+userGlobalData.cartAllPrice==0){dontNeedPay()}if(userGlobalData.shipFee>0){$("#fee").text(userGlobalData.shipFee);$("#shipFee").show()}else{$("#shipFee").hide()}setPayInfo()}function bindCoupon(a){Js.sendData(sendLink.paym_https+"api/web/query/accBindToUser.jsonp","type=ACC-COUPON&get_back=true&card_no="+a,function(b){if(b.status==1){$("#"+a).attr("style","display:block");$("#"+a+"cp").attr("style","display:none")}else{alert(b.message)}})}function checkCash(c,b){var a=(typeof c.coupon!="undefined"?c.coupon:parseInt(userGlobalData.couponCash)||0)+(typeof c.gift!="undefined"?c.gift:userGlobalData.giftCash||0)+(typeof c.virtual!="undefined"?c.virtual:userGlobalData.virtualCash||0)+(typeof c.point!="undefined"?c.point:userGlobalData.pointCash||0)<=userGlobalData.cartAllPrice;if(b){a=(typeof c.coupon!="undefined"?c.coupon:parseInt(userGlobalData.couponCash)||0)+(typeof c.gift!="undefined"?c.gift:userGlobalData.giftCash||0)+(typeof c.virtual!="undefined"?c.virtual:userGlobalData.virtualCash||0)+(typeof c.point!="undefined"?c.point:userGlobalData.pointCash||0)<=userGlobalData.cartAllPrice+(userGlobalData.shipFee||0)}if(c.gift==0||c.coupon==0||c.virtual==0||c.point==0){return false}else{return a}}function ajaxLoad(a){$("#"+a).hide().parent().append('<img src="../htmlResource/images/xy/common/loading.gif" class="inf-button" style="width:40px;" id="ajaxLoad"/>')}function removeAjaxLoad(a){$("#ajaxLoad").remove();$("#"+a).show()}function dontNeedPay(){userGlobalData.PAYMENT_METHOD_ID="ON-LEPAY-BALANCE-ALP";userGlobalData.payInfo="ON-LEPAY-BALANCE-ALP_0_0_0";userGlobalData.noPay=true}function toAddress(){window.scrollBy(0,-100);scrolldelay=setTimeout("toAddress()",1);var a=document.documentElement.scrollTop+document.body.scrollTop;if(a==0){clearTimeout(scrolldelay)}}function setAnimate(b){a($(b).offset());function a(c){$("body,html").animate({scrollTop:c.top-20},250)}}function newToFixed(a){var b=parseFloat(a);var b=Math.round(a*100)/100;var c=b.toString();var d=c.indexOf(".");if(d<0){d=c.length;c+="."}while(c.length<=d+2){c+="0"}return c}var _zpq=_zpq||[];function zpqTuiguang(a){_zpq.push(["_setPageID","817"]);_zpq.push(["_setPageType","orderInfoPage"]);_zpq.push(["_setParams",a.cartAllPid.substring(0,a.cartAllPid.length-1),a.cartAllPrice,a.cartAllPid.split(",").length-1]);_zpq.push(["_setAccount","226"]);load3rdPartyResources()}function load3rdPartyResources(){if(window.attachEvent){window.attachEvent("onload",load3rdPartyResourcesByOrder)}else{window.addEventListener("load",load3rdPartyResourcesByOrder,false)}}function load3rdPartyResourcesByOrder(){includeJS(("https:"==document.location.protocol?"https://":"http://")+"cdn.zampda.net/s.js")};